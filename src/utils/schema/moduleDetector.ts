
/**
 * Module Detection Utilities - Real Implementation
 */

import { supabase } from '@/integrations/supabase/client';
import { moduleRegistry } from '../moduleRegistry';
import { SchemaAnalysis, analyzeTable, calculateConfidence } from './schemaAnalyzer';
import { AutoModuleConfig } from './types';

/**
 * Get all table names from the database
 */
const getAllTableNames = async (): Promise<string[]> => {
  try {
    console.log('üîç Fetching real table names from database...');
    
    const { data, error } = await supabase
      .from('information_schema.tables')
      .select('table_name')
      .eq('table_schema', 'public')
      .eq('table_type', 'BASE TABLE');

    if (error) {
      console.error('Error fetching table names:', error);
      return [];
    }

    const tableNames = data?.map(row => row.table_name) || [];
    console.log(`üìä Found ${tableNames.length} tables:`, tableNames);
    
    return tableNames;
  } catch (error) {
    console.error('Failed to fetch table names:', error);
    return [];
  }
};

/**
 * Scans the database schema and returns analysis for all tables
 */
export const scanDatabaseSchema = async (): Promise<SchemaAnalysis[]> => {
  console.log('üîç Scanning real database schema...');
  
  try {
    const tableNames = await getAllTableNames();
    const analyses: SchemaAnalysis[] = [];
    
    for (const tableName of tableNames) {
      // Skip system/auth tables
      if (tableName.startsWith('_') || 
          tableName.includes('auth') || 
          tableName.includes('storage') ||
          tableName.includes('supabase') ||
          tableName.includes('information_schema')) {
        continue;
      }

      const analysis = await analyzeTable(tableName);
      if (analysis) {
        analyses.push(analysis);
      }
    }
    
    console.log(`üìä Successfully analyzed ${analyses.length} tables`);
    return analyses;
    
  } catch (error) {
    console.error('‚ùå Schema scanning failed:', error);
    return [];
  }
};

/**
 * Auto-detects modules that need component registration or are completely new
 */
export const detectNewModules = async (): Promise<AutoModuleConfig[]> => {
  console.log('üîç Detecting real modules from database...');
  
  const analyses = await scanDatabaseSchema();
  const existingModules = moduleRegistry.getAll();
  
  const modulesToRegister: AutoModuleConfig[] = [];

  for (const analysis of analyses) {
    // Check if module exists in registry
    const existingModule = existingModules.find(m => 
      m.tableName === analysis.tableName || 
      m.moduleName === analysis.suggestedModuleName
    );

    // If module doesn't exist at all, or exists but has no components
    const needsRegistration = !existingModule || 
      (!existingModule.components?.length && 
       !existingModule.services?.length && 
       !existingModule.hooks?.length);

    if (needsRegistration) {
      // Calculate confidence score
      const confidence = calculateConfidence(analysis);

      // Generate suggested custom columns
      const suggestedCustomColumns = generateCustomColumns(analysis);

      const autoConfig: AutoModuleConfig = {
        tableName: analysis.tableName,
        moduleName: analysis.suggestedModuleName,
        requiredFields: analysis.suggestedRequiredFields,
        optionalFields: analysis.suggestedOptionalFields,
        isAutoGenerated: true,
        confidence,
        suggestedCustomColumns
      };

      modulesToRegister.push(autoConfig);
      console.log(`üìù Real module ${autoConfig.moduleName} needs registration (confidence: ${Math.round(confidence * 100)}%)`);
    }
  }

  console.log(`‚úÖ Detected ${modulesToRegister.length} real modules for registration`);
  return modulesToRegister;
};

/**
 * Generates suggested custom columns based on table structure
 */
const generateCustomColumns = (analysis: SchemaAnalysis) => {
  const columns = [];

  // Add name column if exists
  if (analysis.columns.some(col => col.name === 'name' || col.name === 'title')) {
    columns.push({
      key: 'name',
      header: 'Name',
      type: 'text' as const
    });
  }

  // Add status column if exists
  if (analysis.hasStatus) {
    columns.push({
      key: 'status',
      header: 'Status',
      type: 'status' as const
    });
  }

  // Add created_at if exists
  if (analysis.hasCreatedAt) {
    columns.push({
      key: 'created_at',
      header: 'Created',
      type: 'date' as const
    });
  }

  return columns;
};
